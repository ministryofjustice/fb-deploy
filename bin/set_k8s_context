#!/bin/bash
set -e -u -o pipefail

k8s_cluster_cert=$K8S_CLUSTER_CERT
k8s_cluster_name=$K8S_CLUSTER_NAME
k8s_token=$(echo $K8S_TOKEN | base64 -d)
k8s_namespace=formbuilder-repos
service_account=$SERVICE_ACCOUNT

echo "Setting K8S context for formbuilder-repos namespace"

echo -n ${k8s_cluster_cert} | base64 -d > ./ca.crt
kubectl config set-cluster ${k8s_cluster_name} --certificate-authority=./ca.crt --server=https://api.${k8s_cluster_name}
kubectl config set-credentials ${service_account} --token=${k8s_token}
kubectl config set-context ${service_account} --cluster=${k8s_cluster_name} --user=${service_account} --namespace=${k8s_namespace}
kubectl config use-context ${service_account}
