#!/bin/bash
set -e -u -o pipefail

source "$(dirname "$0")/set_k8s_context"

circle_token=$(kubectl get secrets -n formbuilder-repos circleci-api-token -o jsonpath="{.data.token}" | base64 -d)

# Trigger new pipeline
#
results=$(curl -u ${circle_token}: -X POST https://circleci.com/api/v2/project/github/ministryofjustice/fb-acceptance-tests/pipeline \
   -H 'Content-Type: application/json' -H 'Accept: application/json')

pipeline_id=$(echo "$results" | jq --raw-output '.id')
pipeline_number=$(echo "$results" | jq --raw-output '.number')

## Retry for 22 minutes (maximum time of the slowest acceptance test)
##
retries=132
sleeping_time=10

for (( i = 0; i < retries; i++ )); do
  echo "=================================================================="
  workflow_results=$(curl -X GET "https://circleci.com/api/v2/pipeline/${pipeline_id}/workflow" \
    -H 'Accept: application/json' \
    -H "Circle-Token: ${circle_token}")

  workflow_id=$(echo "$workflow_results" | jq --raw-output '.items[0].id')
  workflow_state=$(echo "$workflow_results" | jq --raw-output '.items[0].status')

  circle_link="https://app.circleci.com/pipelines/github/ministryofjustice/fb-acceptance-tests/${pipeline_number}/workflows/${workflow_id}"

  echo
  echo "Pipeline '${circle_link}' is ${workflow_state}."

  if [[ $workflow_state == 'success' ]]; then
    echo "Acceptance tests successfully completed."
    exit 0
  fi

  if [[ $workflow_state == 'failed' ]]; then
    echo "Acceptance tests failed."
    exit 1
  fi

  sleep $sleeping_time
done

echo "Unable to determine what happened with the pipeline"
exit 1
