#!/usr/bin/env sh
set -e -u -o pipefail

app_name=$1

ecr_repos=$(kubectl get secrets -n formbuilder-repos)

for repo in ${ecr_repos[@]}; do
  if [[ $repo == *"circleci-formbuilder-repos-token"* ]]; then
    circle_secret_name=$repo
  fi
done

cert=$(kubectl get secrets -n formbuilder-repos ${circle_secret_name} -o json |  jq -r '.data["ca.crt"]')
token=$(kubectl get secrets -n formbuilder-repos ${circle_secret_name} -o json |  jq -r '.data["token"]')

echo "Set these environment variables in your CI"
echo
echo "K8S_CLUSTER_NAME=live-1.cloud-platform.service.justice.gov.uk"
echo
echo "SERVICE_ACCOUNT=circleci"
echo
echo "K8S_CLUSTER_CERT=${cert}"
echo
echo "K8S_TOKEN=${token}"
echo

ecr_credentials_secret="ecr-repo-${app_name}"

if [[ ${ecr_repos[@]} =~ ${ecr_credentials_secret} ]]; then
  echo "ECR_CREDENTIALS_SECRET=${ecr_credentials_secret}"
else
  echo "${ecr_credentials_secret} does not exist in repo list:"
  echo $(kubectl get secrets -n formbuilder-repos -o json | jq '.items[] | .metadata["name"]')
fi

echo
echo "==========================================="
echo "| K8S_TOKEN for all platform environments |"
echo "==========================================="
echo

namespaces=('test-dev' 'test-production' 'live-dev' 'live-production')

for namespace in ${namespaces[@]}; do
  secrets=$(kubectl get secrets -n formbuilder-platform-${namespace})

  for secret in ${secrets[@]}; do
    if [[ $secret == *"circleci-formbuilder-platform-${namespace}"* ]]; then
      k8s_namespace_token=$(kubectl get secrets -n formbuilder-platform-${namespace} ${secret} -o jsonpath="{.data.token}")
      formatted_namespace=$(echo ${namespace} | tr '-' '_' | tr [a-z] [A-Z])
      echo
      echo "K8S_TOKEN_${formatted_namespace}=${k8s_namespace_token}"
    fi
  done
done
echo

echo "SSH_FILE_FOR_SECRETS is used for cloning the git crypt secrets repository and clone."
echo "SSH_FILE_FOR_SECRETS='You need to add fingerprints to Github and then add as env var in the CI config file'"
echo "CircleCI docs: https://circleci.com/docs/2.0/add-ssh-key/"
echo "Github docs: https://circleci.com/docs/2.0/gh-bb-integration/#creating-a-github-deploy-key"
echo

echo "ENCODED_GIT_CRYPT_KEY=No idea how to find"
