#!/usr/bin/env sh
set -e -u -o pipefail

app_name=$1

ecr_repos=$(kubectl get secrets -n formbuilder-repos)

for repo in ${ecr_repos[@]}; do
  if [[ $repo == *"circleci-formbuilder-repos-token"* ]]; then
    circle_secret_name=$repo
  fi
done

cert=$(kubectl get secrets -n formbuilder-repos ${circle_secret_name} -o json |  jq -r '.data["ca.crt"]')
token=$(kubectl get secrets -n formbuilder-repos ${circle_secret_name} -o json |  jq -r '.data["token"]')

echo "K8S_CLUSTER_NAME=live-1.cloud-platform.service.justice.gov.uk"
echo
echo "SERVICE_ACCOUNT=circleci"
echo
echo "Set these environment variables in your CI"
echo
echo "K8S_CLUSTER_CERT=${cert}"
echo
echo "K8S_TOKEN=${token}"
echo

ecr_credentials_secret="ecr-repo-${app_name}"

if [[ ${ecr_repos[@]} =~ ${ecr_credentials_secret} ]]; then
  echo "ECR_CREDENTIALS_SECRET=${ecr_credentials_secret}"
else
  echo "${ecr_credentials_secret} does not exist in repo list:"
  echo $(kubectl get secrets -n formbuilder-repos -o json | jq '.items[] | .metadata["name"]')
fi
