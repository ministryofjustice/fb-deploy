#!/bin/bash
set -e -u -o pipefail

source "$(dirname "$0")/set_k8s_context"

get_images() {
  kubectl get pods -n "$1" -o jsonpath="{..image}" | tr -s '[[:space:]]' '\n' | sort | uniq
}

## Platform environment: test or live
#
platform_environment=$PLATFORM_ENV

## Deployment environment: dev (draft), production (published)
#
deployment_environment=${DEPLOYMENT_ENV-}

if [ -z "$deployment_environment" ]; then
  environment_full_name="${platform_environment}"
else
  environment_full_name="${platform_environment}-${deployment_environment}"
fi

## Concatenate K8S_TOKEN_TEST_DEV for example
##
k8s_environment_name=$(echo ${environment_full_name} | tr '-' '_' | tr [a-z] [A-Z]})
k8s_token_env_var_name="K8S_TOKEN_${k8s_environment_name}"
k8s_token=$(eval "echo \${$k8s_token_env_var_name}" | base64 -d)

build_SHA=$BUILD_SHA
application_name=$APPLICATION_NAME
namespace=$K8S_NAMESPACE

ssh_file_for_secrets=$SSH_FILE_FOR_SECRETS
encoded_git_crypt_key=$ENCODED_GIT_CRYPT_KEY

credential_name="circleci_$(echo ${environment_full_name} | tr '-' '_')"

################################################################
## Begin setting kubernetes context
################################################################

set_context "${credential_name}" "${namespace}" ${k8s_token}

echo "apply kubernetes changes to ${platform_environment} ${deployment_environment}"

helm_command=''
chartname="${application_name}-chart"
config_file="/tmp/${application_name}-${environment_full_name}.yaml"

################################################################
## Begin git crypt
################################################################

if [[ ! -d app-secrets ]]; then
  GIT_SSH_COMMAND="ssh -v -i ${ssh_file_for_secrets} -o \"IdentitiesOnly=yes\"" git clone git@github.com:ministryofjustice/${application_name}-deploy.git app-secrets
  echo ${encoded_git_crypt_key} | base64 -d > app-secrets/git_crypt.key
  cd app-secrets && git-crypt unlock git_crypt.key && cd ..
  pwd
fi

values_config="app-secrets/values/${environment_full_name}-values.yaml"
if [[ -f "$values_config" ]]; then
  helm_command="${helm_command} -f $values_config"
else
  echo "${values_config} not found. Skipping"
fi

shared_config="app-secrets/secrets/shared-secrets-values.yaml"
if [[ -f "$shared_config" ]]; then
  helm_command="${helm_command} -f $shared_config"
else
  echo "${shared_config} not found. Skipping"
fi

secrets_config="app-secrets/secrets/${environment_full_name}-secrets-values.yaml"
if [[ -f "$secrets_config" ]]; then
  helm_command="${helm_command} -f $secrets_config"
else
  echo "${secrets_config} not found. Skipping"
fi

helm_command="helm template deploy/${chartname} $helm_command --set circleSha1=${build_SHA} --set environmentName=${environment_full_name} --set platformEnv=${platform_environment}"

echo $helm_command

################################################################
# Begin applying configuration
################################################################

echo "Writing ${environment_full_name} config to $config_file"
$helm_command > $config_file

current_images=$(get_images "${namespace}")

echo "Applying configuration"
kubectl apply -f $config_file -n "${namespace}"

################################################################
# Begin rollout and restart
################################################################

deployments=$(kubectl get deployments -n ${namespace})

for current_image in ${current_images}; do
  if [[ $current_image == *$application_name* ]]; then
    image_deployed=false
    app_image_name=$(echo ${current_image} | awk -F'formbuilder/' '{print $NF}' | cut -f1 -d":")

    for deployment in ${deployments}; do
      if [[ $deployment == *$app_image_name* ]]; then
        current_SHA=${current_image##*:}

        # If the current SHA and the build SHA are the same then it is a redeployment
        # of the last commit and kubectl apply will not restart the pods.
        # In this instance we need to call rollout restart
        if [[ $current_SHA = $build_SHA ]]; then
          echo "Current SHA and the build SHA are the same"
          echo "Rolling out and restarting pods for ${deployment}"
          kubectl -n ${namespace} rollout restart deployment ${deployment}
        fi

        kubectl -n ${namespace} rollout status deployment ${deployment}

        echo "Checking correct image was deployed with sha: ${build_SHA}"
        new_images=$(get_images "${namespace}")

        for image in ${new_images}; do
          if [[ $image == *$build_SHA* ]]; then
            echo "Successfully rolled out and restarted ${deployment} pods in ${namespace}"
            image_deployed=true
          fi
        done
      fi
    done

    if [[ "${image_deployed}" = false ]]; then
      echo "Unable to find image using ${build_SHA}"
      exit 1
    fi
  fi
done

echo "Rollout and restart completed"
