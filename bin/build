#!/bin/bash
set -e -u -o pipefail

source "$(dirname "$0")/set_k8s_context"

# $1 repository name
# $2 image tag
skip_build_and_push() {
  # Returns a "An error occurred (ImageNotFoundException)" if image doesn't exist and a non zero code
  aws ecr describe-images --repository-name "$1" --image-ids imageTag="$2" >> /dev/null

  if [[ $? == 0 ]]; then
    echo "Image with $2 already exists in $1"
    echo "Not building or pushing a new image"
  else
    return 1
  fi
}

# $1 ECR repo URL
# $2 environment name
# $3 Image tag
# $4 Dockerfile path
build_and_push() {
  echo "Building image for environment $2 and build SHA $3..."
  docker build -t "$1:latest-$2" -t "$1:$3" -f "$4" .

  echo "Pushing image for latest-$2"
  docker push "$1:latest-$2"

  echo "Pushing build SHA $3 image..."
  docker push "$1:$3"
}

k8s_token=$(echo $K8S_TOKEN | base64 -d)
k8s_namespace=formbuilder-repos

ecr_credentials_secret=$ECR_CREDENTIALS_SECRET

environment_name=$ENVIRONMENT_NAME
build_SHA=$BUILD_SHA

echo "build and push docker images"
echo "SHA is ${build_SHA}"

set_context "circleci" ${k8s_namespace} ${k8s_token}

echo "Getting ECR credentials"
ecr_username=$(kubectl get secrets -n formbuilder-repos ecr-credentials -o jsonpath="{.data.ecr_username}" | base64 -d)
ecr_password=$(kubectl get secrets -n formbuilder-repos ecr-credentials -o jsonpath="{.data.ecr_password}" | base64 -d)

echo "Finding right ecr repos from ${k8s_namespace}"
ecr_credentials=$(kubectl get secrets -n formbuilder-repos)

for ecr_credential in ${ecr_credentials[@]}; do
  if [[ ${ecr_credential} == *"${ecr_credentials_secret}"* ]]; then
    ecr_credential_match="${ecr_credentials_secret}-"
    application_type=${ecr_credential#"$ecr_credential_match"}

    # if the ecr name doesn't have a type (e.g ecr-fb-user-datastore-api)
    # then use Dockerfile.
    # But if it has a type (e.g ecr-repo-fb-submitter-worker or
    # ecr-repo-fb-submitter-api) the dockerfile to be build will be
    # located in docker/worker/Dockerfile
    #
    if [[ $application_type == $ecr_credentials_secret ]]; then
      dockerfile="./Dockerfile"
    else
      dockerfile="./docker/${application_type}/Dockerfile"
    fi

    if [[ -f $dockerfile ]]; then
      echo "Getting secrets from AWS"
      export AWS_DEFAULT_REGION=eu-west-2
      export AWS_ACCESS_KEY_ID=$(kubectl get secrets -n formbuilder-repos ${ecr_credential} -o jsonpath='{.data.access_key_id}' | base64 -d)
      export AWS_SECRET_ACCESS_KEY=$(kubectl get secrets -n formbuilder-repos ${ecr_credential} -o jsonpath='{.data.secret_access_key}' | base64 -d)
      export ECR_REPO_URL=$(kubectl get secrets -n formbuilder-repos ${ecr_credential} -o jsonpath='{.data.repo_url}' | base64 -d)

      echo 'Logging into AWS ECR...'
      aws ecr get-login-password --region eu-west-2 | docker login --username ${ecr_username} --password-stdin ${ecr_password}

      build_and_push ${ECR_REPO_URL} ${environment_name} ${build_SHA}  ${dockerfile}
    else
      echo "Dockerfile ${dockerfile} not found! :("
    fi
  fi
done
