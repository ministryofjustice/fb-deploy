#!/usr/bin/env sh
set -e -u -o pipefail

k8s_cluster_cert=$K8S_CLUSTER_CERT
k8s_cluster_name=$K8S_CLUSTER_NAME
k8s_token=$K8S_TOKEN
k8s_namespace=$K8S_NAMESPACE
service_account=$SERVICE_ACCOUNT

ecr_credentials_secret=$ECR_CREDENTIALS_SECRET
ecr_username=$ECR_USERNAME
ecr_password=$ECR_PASSWORD

environment_name=$ENVIRONMENT_NAME
build_SHA=$BUILD_SHA

echo "build and push docker images"
echo "SHA is ${build_SHA}"

if [[ -n build_SHA ]]; then
  echo "Build sha environment variable should be set"
  exit 1
fi

echo -n ${k8s_cluster_cert} | base64 -d > ./ca.crt
kubectl config set-cluster ${k8s_cluster_name} --certificate-authority=./ca.crt --server=https://api.${k8s_cluster_name}
kubectl config set-credentials ${service_account} --token=${k8s_token}
kubectl config set-context ${k8s_cluster_name} --cluster=${k8s_cluster_name} --user=${service_account} --namespace=${k8s_namespace}
kubectl config use-context ${k8s_cluster_name}

export AWS_DEFAULT_REGION=eu-west-2
export AWS_ACCESS_KEY_ID=$(kubectl get secrets -n ${k8s_namespace} ${ecr_credentials_secret} -o json | jq -r '.data["access_key"]' | base64 -d)
export AWS_SECRET_ACCESS_KEY=$(kubectl get secrets -n ${k8s_namespace} ${ecr_credentials_secret} -o json | jq -r '.data["secret_access_key"]' | base64 -d)
export ECR_REPO_URL=$(kubectl get secrets -n ${k8s_namespace} ${ecr_credentials_secret} -o json | jq -r '.data["repo_url"]' | base64 -d)

echo  'Building docker image...'
out=$(docker build -t ${ECR_REPO_URL}:latest-${environment_name} -t ${ECR_REPO_URL}:${build_SHA} -f ./Dockerfile .)
echo $out

echo 'Logging into AWS ECR...'
out=$(aws ecr get-login-password --region eu-west-2 | docker login --username ${ecr_username} --password-stdin ${ecr_password})
echo $out

echo 'Pushing latest docker image...'
out=$(docker push ${ECR_REPO_URL}:latest-${environment_name})
echo $out

echo 'Pushing current build SHA docker image...'
out=$(ocker push ${ECR_REPO_URL}:${build_SHA})
echo $out
